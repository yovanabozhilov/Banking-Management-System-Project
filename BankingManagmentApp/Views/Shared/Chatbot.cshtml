@if (User?.Identity?.IsAuthenticated == true)
{
<div id="chatbot-container" class="card shadow-lg border-0"
     style="position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px; display: none; flex-direction: column; z-index: 1050;">

    <div class="card-header d-flex justify-content-between align-items-center bg-chat text-white">
        <span>AI Banking Assistant</span>
        <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="toggleChatbot()"></button>
    </div>

    <div id="chatWindowBot" class="card-body overflow-auto d-flex flex-column" style="background-color: var(--bs-body-bg);">
    </div>

    <div class="d-flex flex-wrap p-2 border-top">
        <button class="btn btn-sm btn-outline-chat m-1" onclick="sendQuick('Create Account')">Create Account</button>
        <button class="btn btn-sm btn-outline-chat m-1" onclick="sendQuick('Forgot Password')">Forgot Password</button>
        <button class="btn btn-sm btn-outline-chat m-1" onclick="sendQuick('Account Security')">Account Security</button>
        <button class="btn btn-sm btn-outline-chat m-1" onclick="sendQuick('Update Profile')">Update Profile</button>
        <button class="btn btn-sm btn-outline-chat m-1" onclick="sendQuick('Manage Security')">Manage Security</button>
        <button class="btn btn-sm btn-outline-chat m-1" onclick="sendQuick('No Transactions')">No Transactions</button>
        <button class="btn btn-sm btn-outline-chat m-1" onclick="sendQuick('Apply Loan')">Apply Loan</button>
        <button class="btn btn-sm btn-outline-chat m-1" onclick="sendQuick('Improve Credit')">Improve Credit</button>
        <button class="btn btn-sm btn-outline-chat m-1" onclick="sendQuick('Loan Documents')">Loan Documents</button>
        <button class="btn btn-sm btn-outline-chat m-1" onclick="sendQuick('Early Repayment')">Early Repayment</button>
    </div>

    <div class="card-footer d-flex">
        <input id="promptBot" type="text" class="form-control me-2" placeholder="Type a message..."
               onkeypress="if(event.key==='Enter'){sendMessageBot();}" />
        <button class="btn btn-chat" onclick="sendMessageBot()">Send</button>
    </div>
</div>

<button id="chatbot-toggle"
        class="btn btn-chat rounded-circle shadow d-flex align-items-center justify-content-center"
        style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 1050;"
        onclick="toggleChatbot()">
    💬
</button>

<script>
  function toggleChatbot() {
    const chat = document.getElementById("chatbot-container");
    const toggleBtn = document.getElementById("chatbot-toggle");
    if (chat.style.display === "none") {
      chat.style.display = "flex";
      toggleBtn.style.display = "none";
    } else {
      chat.style.display = "none";
      toggleBtn.style.display = "inline-flex";
    }
  }

  function addMessageBot(text, sender) {
    const chatWindow = document.getElementById('chatWindowBot');
    const msgDiv = document.createElement('div');
    msgDiv.classList.add("p-2", "mb-2", "rounded", "text-break");

    if (sender === "user") {
      msgDiv.classList.add("bubble-user", "align-self-end");
      msgDiv.innerText = text;
    } else {
      msgDiv.classList.add("bubble-ai", "align-self-start");
      msgDiv.innerText = text;
    }

    chatWindow.appendChild(msgDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  let typingEl = null;
  function showTypingBot() {
    const chatWindow = document.getElementById('chatWindowBot');
    hideTypingBot();
    typingEl = document.createElement('div');
    typingEl.classList.add("typing-bubble", "align-self-start", "p-2", "mb-2", "rounded");
    typingEl.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    chatWindow.appendChild(typingEl);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  function hideTypingBot() {
    if (typingEl) { typingEl.remove(); typingEl = null; }
  }

  function sendQuick(question) {
    const input = document.getElementById('promptBot');
    input.value = question;
    sendMessageBot();
  }

  async function sendMessageBot() {
    const input = document.getElementById('promptBot');
    const prompt = input.value.trim();
    if (!prompt) return;

    addMessageBot(prompt, "user");
    input.value = "";

    showTypingBot();

    try {
      const res = await fetch('/chat/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: prompt })
      });

      const data = await res.json();
      hideTypingBot();
      addMessageBot(data.reply ?? "(no reply)", "ai");
    } catch (e) {
      hideTypingBot();
      addMessageBot("Sorry, something went wrong. Please try again.", "ai");
      console.error(e);
    }
  }
</script>
}
